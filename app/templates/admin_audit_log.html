{% extends "admin_base.html" %}
{% block title %}操作紀錄 - AuthCenter Admin{% endblock %}

{% block extra_style %}
<style>
    .pagination {
        display: flex;
        gap: 4px;
        align-items: center;
        justify-content: center;
        margin-top: 16px;
        font-size: 13px;
    }
    .pagination a, .pagination span {
        padding: 6px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        text-decoration: none;
        color: var(--text-main);
    }
    .pagination a:hover { background: #f3f4f6; }
    .pagination .current { background: var(--primary); color: #fff; border-color: var(--primary); }
    .pagination .disabled { color: var(--text-muted); cursor: default; }
    .action-badge {
        display: inline-block;
        font-size: 11px;
        font-weight: 500;
        padding: 2px 7px;
        border-radius: 4px;
    }
    .action-login { background: #eff6ff; color: #1e40af; }
    .action-grant { background: #ecfdf5; color: #166534; }
    .action-revoke { background: #fef2f2; color: #991b1b; }
    .action-create { background: #f0fdf4; color: #166534; }
    .action-delete { background: #fef2f2; color: #991b1b; }
    .action-update { background: #fffbeb; color: #92400e; }
    .action-assign { background: #eff6ff; color: #1e40af; }
    .action-remove { background: #fef2f2; color: #991b1b; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>操作紀錄</h1>
    <p>共 {{ total }} 筆記錄{% if not is_super %}（僅顯示與您相關的操作）{% endif %}</p>
</div>

<div class="admin-card">
    {% if logs %}
    <table class="data-table">
        <thead>
            <tr>
                <th>時間</th>
                <th>操作者</th>
                <th>操作</th>
                <th>對象</th>
                <th>詳情</th>
                <th>IP</th>
            </tr>
        </thead>
        <tbody>
        {% for log in logs %}
            <tr>
                <td style="font-size: 12px; white-space: nowrap; color: var(--text-muted);">{{ log.created_at }}</td>
                <td>{{ log.admin_name }}</td>
                <td>
                    {% set action = log.action %}
                    {% if 'login' in action %}
                    <span class="action-badge action-login">{{ action }}</span>
                    {% elif 'grant' in action %}
                    <span class="action-badge action-grant">{{ action }}</span>
                    {% elif 'revoke' in action or 'remove' in action %}
                    <span class="action-badge action-revoke">{{ action }}</span>
                    {% elif 'create' in action %}
                    <span class="action-badge action-create">{{ action }}</span>
                    {% elif 'delete' in action %}
                    <span class="action-badge action-delete">{{ action }}</span>
                    {% elif 'update' in action %}
                    <span class="action-badge action-update">{{ action }}</span>
                    {% elif 'assign' in action %}
                    <span class="action-badge action-assign">{{ action }}</span>
                    {% else %}
                    <span class="action-badge" style="background: #f3f4f6; color: #374151;">{{ action }}</span>
                    {% endif %}
                </td>
                <td style="font-size: 12px;">{{ log.target }}</td>
                <td style="font-size: 12px; color: var(--text-muted); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ log.details }}">{{ log.details }}</td>
                <td style="font-size: 11px; color: var(--text-muted);">{{ log.ip_address }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="/admin/audit-log?page={{ page - 1 }}">上一頁</a>
        {% else %}
        <span class="disabled">上一頁</span>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <span class="current">{{ p }}</span>
            {% elif p <= 3 or p > total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="/admin/audit-log?page={{ p }}">{{ p }}</a>
            {% elif p == 4 or p == total_pages - 2 %}
            <span>...</span>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <a href="/admin/audit-log?page={{ page + 1 }}">下一頁</a>
        {% else %}
        <span class="disabled">下一頁</span>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">尚無操作紀錄。</div>
    {% endif %}
</div>
{% endblock %}
